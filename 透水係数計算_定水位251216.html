
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>定水位法（Constant Head）透水係数 k 計算フォーム（幾何自動計算付き）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
         max-width: 1100px; margin: 24px auto; padding: 0 16px; line-height: 1.6; }
  h1 { font-size: 1.35rem; margin-bottom: 8px; }
  fieldset { border: 1px solid #d0d7de; padding: 12px; margin-bottom: 16px; }
  legend { font-weight: 600; }
  label { display:block; margin-top: 10px; }
  input, select, button { width: 100%; padding: 8px; box-sizing: border-box; }
  .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
  .output { margin-top: 16px; padding: 12px; background: #f6f8fa; border: 1px solid #d0d7de; }
  .note { font-size: 0.92em; color: #555; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .btn { cursor: pointer; }
  /* バリデーション赤枠 */
  .error { border: 2px solid #d93025 !important; background: #fff7f7; }
  .help { color: #d93025; font-size: 0.9em; margin-top: 6px; }
  /* レスポンシブ（狭幅時は2列→1列へ） */
  @media (max-width: 900px) {
    .grid3 { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 640px) {
    .grid3 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<h1>土の透水試験（定水位法）— 透水係数 k（m/s）計算［幾何自動計算付き］</h1>
<p class="note">
  使用式：<code class="mono">k = (Q · L) / (A · h)</code>（出力：m/s）<br>
  参考：JIS A 1218:2020／NPO住宅地盤品質協会（定水位法）。
</p>

<!-- 採取体積 V と採取時間 t -->
<fieldset id="modeVt">
  <legend>採取体積 V と採取時間 t</legend>

  <div class="grid3">
    <div>
      <label>採取体積 V
        <input id="Vval" type="number" step="any" placeholder="例：500" aria-describedby="VvalHelp">
      </label>
      <div id="VvalHelp" class="help" style="display:none;">V を正の数値で入力してください。</div>
    </div>
    <div>
      <label>V の単位
        <select id="Vunit">
          <option value="cm3">cm³</option>
          <option value="m3">m³</option>
          <option value="L">L</option>
          <option value="ml">mL</option>
        </select>
      </label>
    </div>
    <div>
      <label>採取時間 t（秒）
        <input id="tsec" type="number" step="any" placeholder="例：60" aria-describedby="tsecHelp">
      </label>
      <div id="tsecHelp" class="help" style="display:none;">t は正の秒数で入力してください。</div>
    </div>
  </div>
</fieldset>

<!-- 幾何の自動計算 -->
<fieldset>
  <legend>幾何の自動計算（任意）— 円筒の直径から断面積を自動算出</legend>
  <p class="note">円筒の断面積は <code class="mono">A = π D² / 4</code>。</p>

  <div class="grid3">
    <div>
      <label>試料直径 D
        <input id="Dsample" type="number" step="any" placeholder="例：0.10">
      </label>
    </div>
    <div>
      <label>D の単位
        <select id="Dunit">
          <option value="cm">cm</option>
          <option value="m">m</option>
        </select>
      </label>
    </div>
    <div>
      <label>（計算結果）供試体断面積 A（自動）
        <output id="Acalc" class="mono">—</output>
      </label>
    </div>
  </div>

  <div class="grid3">
    <div>
      <button id="reflectA" class="btn">Aに反映（下の A 入力欄へ単位系に合わせてセット）</button>
    </div>
    <div></div><div></div>
  </div>
</fieldset>

<!-- 長さ・面積系、試料寸法・水頭差 -->
<fieldset>
  <legend>試料寸法・水頭差（長さ系は m／cm の選択可）</legend>

  <div class="grid3">
    <div>
      <label>単位系（長さ・面積）
        <select id="lenUnits">
          <option value="cm">センチメートル系（L,h: cm／A: cm² → 自動で m に換算）</option>
          <option value="m">メートル系（L,h: m／A: m²）</option>
        </select>
      </label>
    </div>
    <div>
      <label>（任意）水温 T［℃］
        <input id="temp" type="number" step="any" placeholder="例：20">
      </label>
    </div>
    <div>
      <label>基準温度（補正）
        <select id="Tref">
          <option value="15">基準 15℃</option>
          <option value="20">基準 20℃</option>
        </select>
      </label>
    </div>
  </div>

  <div class="grid3">
    <div>
      <label>試料長 L
        <input id="L" type="number" step="any" placeholder="例：0.10" aria-describedby="LHelp">
      </label>
      <div id="LHelp" class="help" style="display:none;">L を正の数値で入力してください。</div>
    </div>
    <div>
      <label>試料断面積 A（円筒なら A=πD²/4）
        <input id="A" type="number" step="any" placeholder="例：7.854e-4" aria-describedby="AHelp">
      </label>
      <div id="AHelp" class="help" style="display:none;">A を入力するか、上の D から自動計算値を反映してください。</div>
    </div>
    <div>
      <label>水頭差 h（上流面と下流面の差）
        <input id="h" type="number" step="any" placeholder="例：0.50" aria-describedby="hHelp">
      </label>
      <div id="hHelp" class="help" style="display:none;">h を正の数値で入力してください。</div>
    </div>
  </div>
</fieldset>

<button id="calc" class="btn">計算する</button>
<div class="output" id="result"></div>

<p class="note">
  ★ 単位換算ルール：<br>
  ・長さ／面積が <b>cm系</b>の場合は、内部で <code class="mono">L,h → ×1e-2</code>、<code class="mono">A → ×1e-4</code> として SI（m,s）に統一。<br>
  ・流量／体積はそれぞれ <b>m³/s</b>／<b>m³</b> に換算。例：<code class="mono">1 L/s → 1e-3 m³/s</code>、<code class="mono">500 mL → 5e-4 m³</code>。<br>
  ・温度補正：<code class="mono">k_ref = k_T · (μ_T / μ_ref)</code>（動粘度 μ）。近似値テーブルを内蔵し、15–30℃近傍の概略補正に対応。詳細は規格等の粘度表をご参照ください。
</p>

<script>
// ===== 体積のSI換算（m³へ）=====
function to_m3_from_V(V, unit) {
  if (!Number.isFinite(V)) return NaN;
  const f = { m3: 1, L: 1e-3, ml: 1e-6, cm3: 1e-6 }[unit] ?? NaN;
  return V * f;
}

// ===== 長さ系換算（m系へ統一）=====
function to_SI_lengths(val, units, kind) {
  // kind: 'Lh'（L,h）なら ×1e-2（cm→m）、'A'なら ×1e-4（cm²→m²）
  if (!Number.isFinite(val)) return NaN;
  if (units === 'm') return val;
  if (units === 'cm') {
    if (kind === 'Lh') return val * 1e-2;
    if (kind === 'A')  return val * 1e-4;
  }
  return NaN;
}

// ===== 幾何の自動計算（円筒：A = π D² / 4）=====
const Dsample     = document.getElementById('Dsample');
const Dunit       = document.getElementById('Dunit');
const AcalcOut    = document.getElementById('Acalc');
const reflectABtn = document.getElementById('reflectA');

function updateGeom() {
  const Dv = parseFloat(Dsample.value);
  if (Number.isFinite(Dv) && Dv > 0) {
    const D_m  = (Dunit.value === 'm') ? Dv : Dv * 1e-2;
    const A_m2 = Math.PI * Math.pow(D_m, 2) / 4;
    const A_cm2= A_m2 * 1e4;
    AcalcOut.textContent = `${A_m2.toExponential(6)} m²  /  ${A_cm2.toExponential(6)} cm²`;
    AcalcOut.dataset.A_m2 = A_m2; // 内部利用
  } else {
    AcalcOut.textContent = '—';
    AcalcOut.dataset.A_m2 = '';
  }
}
[Dsample, Dunit].forEach(el => el.addEventListener('input', updateGeom));
updateGeom();

// 「Aに反映」— 現在の長さ単位系に合わせて A 入力欄へセット
const lenUnitsSel = document.getElementById('lenUnits');
const Ainput      = document.getElementById('A');
reflectABtn.addEventListener('click', () => {
  const A_m2_str = AcalcOut.dataset.A_m2;
  if (!A_m2_str) {
    alert('試料直径 D を入力してください。');
    return;
  }
  const A_m2 = parseFloat(A_m2_str);
  if (lenUnitsSel.value === 'm') {
    Ainput.value = A_m2;
  } else {
    Ainput.value = A_m2 * 1e4; // cm²へ
  }
  validateField('A', v => Number.isFinite(parseFloat(v)) && parseFloat(v) > 0, 'AHelp');
});

// ===== 水の動粘度（mPa·s）の簡易近似テーブル（15–30℃）=====
const mu = { // 概略値
  15: 1.138, 16: 1.106, 17: 1.076, 18: 1.047, 19: 1.020,
  20: 1.002, 21: 0.985, 22: 0.969, 23: 0.954, 24: 0.939,
  25: 0.925, 26: 0.912, 27: 0.899, 28: 0.887, 29: 0.875, 30: 0.864
};

// ===== 汎用バリデーション（赤枠ON/OFF & ヘルプ表示）=====
function setError(el, helpId, hasError) {
  if (!el) return;
  el.classList.toggle('error', !!hasError);
  const help = helpId ? document.getElementById(helpId) : null;
  if (help) help.style.display = hasError ? '' : 'none';
}

function validateField(inputId, predicate, helpId) {
  const el = document.getElementById(inputId);
  const val = el.value;
  const ok = predicate(val);
  setError(el, helpId, !ok);
  return ok;
}

function bindPositiveValidator(inputId, helpId) {
  const el = document.getElementById(inputId);
  el.addEventListener('input', () => {
    validateField(inputId, v => Number.isFinite(parseFloat(v)) && parseFloat(v) > 0, helpId);
  });
}

// A は特殊（未入力でも D から自動があればOK）
function validateA() {
  const A_el = document.getElementById('A');
  const A_val = parseFloat(A_el.value);
  const hasA = Number.isFinite(A_val) && A_val > 0;
  const hasAutoA = !!AcalcOut.dataset.A_m2;
  const ok = hasA || hasAutoA;
  setError(A_el, 'AHelp', !ok);
  return ok;
}
document.getElementById('A').addEventListener('input', validateA);
[Dsample, Dunit].forEach(el => el.addEventListener('input', validateA));

// 即時バインド
bindPositiveValidator('Vval', 'VvalHelp');
bindPositiveValidator('tsec', 'tsecHelp');
bindPositiveValidator('L',    'LHelp');
bindPositiveValidator('h',    'hHelp');

// ===== 計算ボタン =====
document.getElementById('calc').addEventListener('click', () => {
  // 前段のバリデーション（赤枠設定）
  const vOk = validateField('Vval', v => Number.isFinite(parseFloat(v)) && parseFloat(v) > 0, 'VvalHelp');
  const tOk = validateField('tsec', v => Number.isFinite(parseFloat(v)) && parseFloat(v) > 0, 'tsecHelp');
  const lOk = validateField('L',    v => Number.isFinite(parseFloat(v)) && parseFloat(v) > 0, 'LHelp');
  const hOk = validateField('h',    v => Number.isFinite(parseFloat(v)) && parseFloat(v) > 0, 'hHelp');
  const aOk = validateA();

  if (!(vOk && tOk && lOk && hOk && aOk)) {
    document.getElementById('result').innerHTML =
      '⚠️ 入力値（V, t, L, A, h）を確認してください。赤枠の項目は修正が必要です。' +
      '<br>・t は秒、L/h は m または cm、A は m² または cm² で入力。' +
      '<br>・A が未入力の場合は「試料直径 D」から自動計算値を使用できます。';
    return;
  }

  // 1) 流量：常に V と t から算出（Q = V/t）
  const Vval = parseFloat(document.getElementById('Vval').value);
  const Vunit = document.getElementById('Vunit').value;
  const tsec = parseFloat(document.getElementById('tsec').value);
  const V_m3  = to_m3_from_V(Vval, Vunit);
  let Q_m3s = V_m3 / tsec;
  if (!(Number.isFinite(tsec) && tsec > 0)) Q_m3s = NaN;

  // 2) 長さ系（L, h, A）
  const units = lenUnitsSel.value;
  const L_in = parseFloat(document.getElementById('L').value);
  const h_in = parseFloat(document.getElementById('h').value);
  let   A_in = parseFloat(Ainput.value);

  // A 未入力なら、試料直径からの自動計算値を使用
  if (!Number.isFinite(A_in) || A_in <= 0) {
    const A_m2_str = AcalcOut.dataset.A_m2;
    if (A_m2_str) {
      const A_m2_auto = parseFloat(A_m2_str);
      A_in = (units === 'm') ? A_m2_auto : A_m2_auto * 1e4;
    }
  }

  const L_m  = to_SI_lengths(L_in, units, 'Lh');
  const h_m  = to_SI_lengths(h_in, units, 'Lh');
  const A_m2 = to_SI_lengths(A_in, units, 'A');

  // 3) 入力チェック（数値安全性）
  const ok = [Q_m3s, L_m, h_m, A_m2].every(v => Number.isFinite(v) && v > 0);
  if (!ok) {
    document.getElementById('result').innerHTML =
      '⚠️ 内部計算で不正な値を検出しました。単位や数値を再確認してください。';
    return;
  }

  // 4) 定水位法：k = (Q · L) / (A · h)
  const k = (Q_m3s * L_m) / (A_m2 * h_m); // [m/s]

  let msg = `<b>k = ${k.toExponential(6)} m/s</b>`;

  // 5) 温度補正（任意）：k_ref = k_T · (μ_T / μ_ref)
  const T  = parseFloat(document.getElementById('temp').value);
  const Tr = parseInt(document.getElementById('Tref').value, 10);
  const muT = mu[Math.round(T)];
  const muR = mu[Tr];
  if (Number.isFinite(T) && muT && muR) {
    const k_ref = k * (muT / muR);
    msg += `<br>温度補正（基準 ${Tr}℃）：<b>k<sub>${Tr}</sub> = ${k_ref.toExponential(6)} m/s</b>（T≈${Math.round(T)}℃）`;
  } else if (Number.isFinite(T)) {
    msg += '<br>※温度補正は 15–30℃近傍の概略値のみ対応。詳細は規格や技術資料の粘度表をご参照ください。';
  }

  // 6) 幾何計算の要約（表示用）
  const A_m2_str = AcalcOut.dataset.A_m2;
  if (A_m2_str) {
    const A_auto_m2 = parseFloat(A_m2_str);
    msg += `<br><br><span class="note">供試体断面積（直径から計算）：A=${A_auto_m2.toExponential(6)} m²</span>`;
  }

  // 7) 入力の要約（SI換算）
  msg += `<br><br><span class="note">入力（SI換算）：V=${V_m3} m³, t=${tsec} s, Q=${Q_m3s} m³/s, L=${L_m} m, A=${A_m2} m², h=${h_m} m</span>`;
  document.getElementById('result').innerHTML = msg;
});
</script>

<hr>
<p class="note">
  ■ 技術メモ：定水位法は、砂質土など比較的高透水性の試料に適用し、定常状態での流量 Q を用いて
  <code class="mono">k = (Q · L) / (A · h)</code> で求めます。幾何ヘルパーは、試料直径から供試体断面積を迅速に確認するための補助機能です。<br>
  参考：NPO住宅地盤品質協会（試験概要・式）／JIS A 1218:2020（試験方法・計算）。
</p>
</body>
</
